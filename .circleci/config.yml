version: 2
jobs:
  test:
    docker:
    - image: circleci/python:3.7.1
      user: root
    - image: circleci/postgres:9.6.2
    - image: google/cloud-sdk:252.0.0-slim
    - image: bitnami/kubectl:1.12.9
    working_directory: ~/repo
    steps:
    - setup_remote_docker
    - checkout
    - restore_cache:
        keys:
        - v1-dependencies-{{ checksum "requirements.txt" }}
        - v1-dependencies-
    - run:
        name: install dependencies
        command: |
          python3 -m venv venv
          . venv/bin/activate
          sed -i 's+https://github.com+https://'"$GH_ACCESS_TOKEN"'@github.com+g' requirements.txt
          pip install -r requirements.txt
    - save_cache:
        paths:
        - ./venv
        key: v1-dependencies-{{ checksum "requirements.txt" }}
    - run:
        name: run tests
        command: |
          . venv/bin/activate
          python -m pytest --cov=./
  build:
    docker:
    - image: google/cloud-sdk:252.0.0-slim
    working_directory: ~/repo
    steps:
    - run: echo 'export PATH=/usr/lib/google-cloud-sdk/bin:$PATH' >> $BASH_ENV
    - run:
        name: Copy gcloud cli and auth for docker push
        command: |-
          echo "$GCLOUD_SERVICE_KEY" | base64 -d > service.json
          gcloud auth activate-service-account --key-file=service.json
          gcloud --quiet config set project ${GOOGLE_PROJECT_ID}
          gcloud --quiet config set compute/zone ${GOOGLE_COMPUTE_ZONE}
          gcloud auth configure-docker
          gcloud container clusters get-credentials --region us-east4 default-codecov-cluster
    - run:
        name: build container
        command: |-
          make build GH_ACCESS_TOKEN=$GH_ACCESS_TOKEN VERSION=$VERSION
    - run:
        name: push container
        command: |-
          make push GH_ACCESS_TOKEN=$GH_ACCESS_TOKEN VERSION=$VERSION
  deploy:
    docker:
    - image: bitnami/kubectl:1.12.9
    working_directory: ~/repo
    steps:
    - run:
        name: configure kubectl
        command: |-
          docker run --detach --entrypoint "/bin/sleep" bitnami/kubectl:1.12.9 -- 60
          docker cp $(docker ps | awk '/bitnami\/kubectl/{print $1}'):/opt/bitnami/kubectl/bin/kubectl /usr/bin/kubectl
          kubectl get pods
    - run:
        name: deploy to k8s
        command: |-
          make deploy VERSION=$VERSION

workflows:
  version: 2
  workflow:
    jobs:
    - test
        filters:
          ignore:
            - master
    - build
        filters:
          branches:
            only:
              - master
              - phildier/circleci-test-build-deploy
    - deploy
        requires:
          - build
